# Copyright: (c) 2023, dbi services, distributed without any warranty under the terms of the GNU General Public License v3
---
- name: Import EPEL GPG key
  become: yes
  rpm_key:
    key: "https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-{{ ansible_distribution_major_version }}"
    state: present
  retries: 3
  delay: 5

- name: Install epel
  become: yes
  ansible.builtin.dnf:
    name: 'https://dl.fedoraproject.org/pub/epel/epel-release-latest-{{ ansible_distribution_major_version }}.noarch.rpm'
    state: present
  retries: 3
  delay: 5

- name: Install LVM
  become: yes
  ansible.builtin.dnf:
    name: lvm2
    state: present
  register: r_dnf
  ignore_errors: yes # Error handled in the next step

- debug: var=r_dnf
  when: debug|bool

- name: Handling of issues 74
  ansible.builtin.fail:
    msg: >
      Package server is not reachable, or certificate from package server is not valid.
      More info on https://gitlab.com/yak4all/yak/-/issues/74
  when: "'Cannot download repomd.xml' in r_dnf.msg"

- name: Handling of any other issues
  ansible.builtin.fail:
    msg: "Error with task 'Install LVM': {{ r_dnf }}"
  when: r_dnf.rc > 0

- name: Install packages
  become: yes
  ansible.builtin.dnf:
    name: '{{ item }}'
    state: present
  loop:
    - xfsprogs
    - htop
    - iotop

