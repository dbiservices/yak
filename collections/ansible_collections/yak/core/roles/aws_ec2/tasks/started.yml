# Copyright: (c) 2023, dbi services, distributed without any warranty under the terms of the GNU General Public License v3
---
- name: Get instance info to find ID
  include_tasks: get_ec2_instance_info.yml

- debug: var=r_ec2_instance_info
  when: debug | bool

- name: Fails if no instance exists
  ansible.builtin.fail:
    msg: No instance '{{ server_name }}' found in state 'pending', 'running', 'shutting-down', 'stopping' or 'stopped'.
  when: r_ec2_instance_info.instances|length != 1

- name: Start EC2 instance
  delegate_to: localhost
  amazon.aws.ec2_instance:
    region: "{{ region_id }}"
    state: started
    instance_ids:
      - "{{ r_ec2_instance_info.instances[0].instance_id }}"

- include_tasks: "post_config_{{ os_type }}.yml"
