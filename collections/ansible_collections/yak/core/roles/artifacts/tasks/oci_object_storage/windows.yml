# Copyright: (c) 2023, dbi services, distributed without any warranty under the terms of the GNU General Public License v3
---
- ansible.builtin.include_role:
    name: yak.core.oci_compute
    tasks_from: check_credential.yml
  vars:
    yak_oci_compute_oci_ansible_auth_type: "{{ yak_artifact_provider_oci_ansible_auth_type }}"
    yak_oci_compute_oci_user_id: "{{ yak_artifact_provider_oci_user_id }}"
    yak_oci_compute_oci_user_fingerprint: "{{ yak_artifact_provider_oci_user_fingerprint }}"
    yak_oci_compute_oci_region: "{{ yak_artifact_provider_oci_region }}"
    yak_oci_compute_oci_tenancy: "{{ yak_artifact_provider_oci_tenancy }}"
    yak_oci_compute_oci_user_key_file: "{{ yak_artifact_provider_oci_user_key_file }}"

- name: Install OCI cli from PowerShell
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  ansible.windows.win_powershell:
    script: |
      New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
      ### https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm#InstallingCLI__windows
      ### Full path of the file
      $file = 'C:\Windows\install.ps1'
      ### If the file does not exist, install OCI client.
      if (-not(Test-Path -Path $file -PathType Leaf)) {
        Set-ExecutionPolicy RemoteSigned -Force
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Invoke-WebRequest https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.ps1 -OutFile install.ps1
        ./install.ps1 -AcceptAllDefaults
      }

- name: Create a directory if it does not exist
  become: true
  become_user: "{{ ansible_user }}"
  become_method: runas
  ansible.builtin.win_file:
    path: C:\Users\Ansible\.oci
    state: directory

- name: Ensure configuration file exists
  become: true
  become_user: "{{ ansible_user }}"
  become_method: runas
  ansible.builtin.win_file:
    path: C:\Users\Ansible\.oci\config
    state: touch

- name: Copy Key File
  become: true
  become_user: "{{ ansible_user }}"
  become_method: runas
  ansible.builtin.copy:
    src: "{{ yak_artifact_provider_oci_user_key_file }}"
    dest: C:\Users\Ansible\.oci\oci_key

- name: Download artifact
  become: yes
  become_user: "{{ ansible_user }}"
  become_method: runas
  ansible.windows.win_shell: |
    oci os object get `
      --namespace {{ artifacts.variables.namespace_name }} `
      --bucket-name {{ artifacts.variables.bucket_name }} `
      --name {{ item }} `
      --file "{{ destination_path }}\\{{ item | replace('/','\\') }}"
  environment:
      OCI_CLI_AUTH            : "{{ yak_artifact_provider_oci_ansible_auth_type }}"
      OCI_CLI_USER            : "{{ yak_artifact_provider_oci_user_id }}"
      OCI_CLI_FINGERPRINT     : "{{ yak_artifact_provider_oci_user_fingerprint }}"
      OCI_CLI_TENANCY         : "{{ yak_artifact_provider_oci_tenancy }}"
      OCI_CLI_REGION          : "{{ yak_artifact_provider_oci_region }}"
      OCI_CLI_KEY_FILE        : 'C:\Users\Ansible\.oci\oci_key'
  loop: "{{ artifact_files }}"

- name: Remove Key File
  become: true
  become_user: "{{ ansible_user }}"
  become_method: runas
  ansible.builtin.win_file:
    path: C:\Users\Ansible\.oci\oci_key
    state: absent
